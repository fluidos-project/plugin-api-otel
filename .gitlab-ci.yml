variables:
  IMAGE_TAG: $CI_REGISTRY_IMAGE:latest
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

default:
  tags:
    - docker
    - priviledge
    - shared

stages:
  - test
  - build

unit_tests:
  stage: test
  image: python:3.11
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
  script:
    - echo "Ejecutando tests unitarios"
    - pytest

build_and_test_image:
  stage: build
  image: docker:25.0.3
  services:
    - name: docker:25.0.3-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache python3 py3-pip
    - pip install pytest httpx
  script:
    - echo "Construyendo plugin-api-otel"
    - docker build -t $IMAGE_TAG .
    - echo "Imagen construida exitosamente"

    - echo "Ejecutando la imagen"
    - docker run -d -p 8000:8000 --name otel-api-pluging-test $IMAGE_TAG
    - echo "Esperando a que arranque"
    - sleep 5
    - echo "Testeando imagen..."
    - pytest test/

    - echo "Matando y limpiando contenedor de test..."
    - docker stop otel-api-pluging-test && docker rm otel-api-pluging-test

    - echo "Publicando imagen de plugin-api-otel"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker push $IMAGE_TAG